<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI Thi·∫øu M√°u C∆° Tim ‚Äì ESC 2023</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background: #F4F7FA; padding: 15px; }
    .card { border-radius: 16px; padding: 20px; border: none;
            box-shadow: 0 4px 14px rgba(0,0,0,0.1); }
    .section-title { font-weight: bold; color: #0D6EFD;
                     font-size: 18px; margin-bottom: 14px; }

    .input-short { max-width: 180px; }
    .input-medium { max-width: 260px; }

    @media (max-width: 576px) {
      .input-short, .input-medium { max-width: 100%; }
    }

    .risk-box, .advice-box {
      padding: 16px; border-radius: 12px;
      margin-top: 12px; font-size: 16px; white-space: pre-line;
    }
    .symptom-box { margin-bottom: 18px; }
  </style>
</head>

<body>
  <h3 class="text-center mb-3"><b>AI Thi·∫øu M√°u C∆° Tim ‚Äì ESC 2023</b></h3>

  <form id="aiForm">

    <!-- TH√îNG TIN -->
    <div class="card mb-4">
      <div class="section-title">1) Th√¥ng tin & Sinh hi·ªáu</div>

      <label>Tu·ªïi</label>
      <input type="number" class="form-control input-short mb-2" name="age">

      <label>Gi·ªõi t√≠nh</label>
      <select class="form-control input-short mb-2" name="sex">
        <option value="nam">Nam</option>
        <option value="nu">N·ªØ</option>
      </select>

      <label>Huy·∫øt √°p (SBP / DBP)</label>
      <div class="input-group input-medium mb-2">
        <input type="number" class="form-control" name="sbp" placeholder="SBP">
        <span class="input-group-text">/</span>
        <input type="number" class="form-control" name="dbp" placeholder="DBP">
      </div>

      <label>M·∫°ch (l·∫ßn/ph√∫t)</label>
      <input type="number" class="form-control input-short mb-2" name="hr">

      <label>SpO‚ÇÇ (%)</label>
      <input type="number" class="form-control input-short mb-2" name="spo2">
    </div>

    <!-- TRI·ªÜU CH·ª®NG ESC -->
    <div class="card mb-4">
      <div class="section-title">2) Tri·ªáu ch·ª©ng theo ESC (Checklist)</div>

      <div class="symptom-box">
        <b>1) V·ªã tr√≠ ƒëau</b><br>
        <label><input type="checkbox" name="loc" value="sau_xuong_uc"> Sau x∆∞∆°ng ·ª©c / ng·ª±c tr√°i</label><br>
        <label><input type="checkbox" name="loc" value="lan_ham"> Lan c·ªï ‚Äì h√†m</label><br>
        <label><input type="checkbox" name="loc" value="lan_vai"> Lan vai ‚Äì tay tr√°i</label><br>
        <label><input type="checkbox" name="loc" value="thuong_vi"> Th∆∞·ª£ng v·ªã</label><br>
      </div>

      <div class="symptom-box">
        <b>2) T√≠nh ch·∫•t ƒëau</b><br>
        <label><input type="checkbox" name="quality" value="tuc_nang">
          T·ª©c n·∫∑ng / b√≥p ngh·∫πt / ƒë√® √©p</label><br>
        <label><input type="checkbox" name="quality" value="dau_nhoi">
          (Lo·∫°i tr·ª´) ƒêau nh√≥i 1 ƒëi·ªÉm</label><br>
      </div>

      <div class="symptom-box">
        <b>3) Kh·ªüi ph√°t ‚Äì gi·∫£m ƒëau</b><br>
        <label><input type="checkbox" name="trigger" value="gang_suc"> ƒêau khi g·∫Øng s·ª©c</label><br>
        <label><input type="checkbox" name="relief" value="nghi"> Gi·∫£m khi ngh·ªâ</label><br>
        <label><input type="checkbox" name="relief" value="nitrate"> Gi·∫£m khi ng·∫≠m nitrate</label><br>
      </div>

      <div class="symptom-box">
        <b>4) Tri·ªáu ch·ª©ng k√®m</b><br>
        <label><input type="checkbox" name="assoc" value="kho_tho"> Kh√≥ th·ªü</label><br>
        <label><input type="checkbox" name="assoc" value="va_mo_h√¥i"> V√£ m·ªì h√¥i</label><br>
        <label><input type="checkbox" name="assoc" value="buon_non"> Bu·ªìn n√¥n / n√¥n</label><br>
      </div>

      <div class="symptom-box">
        <b>5) Di·ªÖn ti·∫øn</b><br>
        <label><input type="checkbox" name="dynamic" value="20p"> ƒêau ‚â• 20 ph√∫t</label><br>
        <label><input type="checkbox" name="dynamic" value="nhieu_con"> Nhi·ªÅu c∆°n trong 24h</label><br>
        <label><input type="checkbox" name="dynamic" value="tang_dan"> TƒÉng d·∫ßn m·ª©c ƒë·ªô</label><br>
      </div>

      <div class="symptom-box">
        <b>6) Kh√¥ng do tim</b><br>
        <label><input type="checkbox" name="noncardiac" value="an_dau"> ƒêau tƒÉng khi ·∫•n</label><br>
        <label><input type="checkbox" name="noncardiac" value="xoay_hit"> TƒÉng khi xoay ng∆∞·ªùi / h√≠t s√¢u</label><br>
      </div>
    </div>

    <!-- Y·∫æU T·ªê NGUY C∆† -->
    <div class="card mb-4">
      <div class="section-title">3) Y·∫øu t·ªë nguy c∆°</div>

      <label><input type="checkbox" name="risk" value="tha"> TƒÉng huy·∫øt √°p</label><br>
      <label><input type="checkbox" name="risk" value="dtd"> ƒê√°i th√°o ƒë∆∞·ªùng</label><br>
      <label><input type="checkbox" name="risk" value="rlld"> R·ªëi lo·∫°n lipid</label><br>
      <label><input type="checkbox" name="risk" value="hut_thuoc"> H√∫t thu·ªëc</label><br>
      <label><input type="checkbox" name="risk" value="bmv"> B·ªánh m·∫°ch v√†nh</label><br>
      <label><input type="checkbox" name="risk" value="beo_phi"> B√©o ph√¨</label><br>
    </div>

    <!-- ECG UPLOAD -->
    <div class="card mb-4">
      <div class="section-title">4) Upload ECG</div>
      <input type="file" accept="image/*" class="form-control" name="ecg_file">
      <div id="ecgAI" class="mt-3"></div>
    </div>

    <button class="btn btn-primary w-100" style="font-size:18px">G·ª≠i t·ªõi AI ph√¢n t√≠ch</button>
  </form>

  <!-- OUTPUT 2 C·ªòT SONG SONG -->
  <div class="row mt-4">
    <div class="col-md-6">
      <div id="symptomBox" class="risk-box"></div>
    </div>

    <div class="col-md-6">
      <div id="riskBox" class="risk-box"></div>
    </div>
  </div>

  <div id="adviceBox" class="advice-box"></div>
  <div id="ecgAI" class="mt-3"></div>

<script>
const API_URL = "https://truongmain.onrender.com/api/analyze";

function safe(v){ return (!v || v=="") ? "none" : v; }

function calcESC(){
  const loc = document.querySelectorAll("input[name='loc']:checked").length;
  const trigger = document.querySelectorAll("input[name='trigger']:checked").length;
  const relief = document.querySelectorAll("input[name='relief']:checked").length;
  let c=0;
  if(loc>0) c++;
  if(trigger>0) c++;
  if(relief>0) c++;
  return c;
}

function calcHEAR(){
  const age = parseInt(document.querySelector("input[name='age']").value || 0);
  const risk = document.querySelectorAll("input[name='risk']:checked").length;
  let A = age>=65?2:(age>=45?1:0);
  let R = risk>=3?2:(risk>=1?1:0);
  const total=A+R;
  let level = total>=4?"high":(total>=2?"moderate":"low");
  return {total,level};
}

document.getElementById("aiForm").addEventListener("submit", async(e)=>{
  e.preventDefault();
  const formData=new FormData(e.target);

  formData.set("age", safe(formData.get("age")));
  formData.set("sex", safe(formData.get("sex")));
  formData.set("sbp", safe(formData.get("sbp")));
  formData.set("dbp", safe(formData.get("dbp")));
  formData.set("hr", safe(formData.get("hr")));
  formData.set("spo2", safe(formData.get("spo2")));

  const esc_count=calcESC();
  const hear=calcHEAR();

  formData.append("esc_criteria", esc_count);
  formData.append("hear_score", hear.total);
  formData.append("hear_level", hear.level);

  document.getElementById("symptomBox").textContent = "‚è≥ ƒêang ph√¢n t√≠ch...";
  document.getElementById("riskBox").textContent = "";
  document.getElementById("adviceBox").textContent = "";

  const res = await fetch(API_URL, { method:"POST", body:formData });
  const data = await res.json();

  // Tri·ªáu ch·ª©ng ESC
  const symptomBox=document.getElementById("symptomBox");
  symptomBox.style.background="#e7f1ff";
  symptomBox.style.borderLeft="5px solid #0d6efd";
  symptomBox.textContent = `Ph√¢n lo·∫°i tri·ªáu ch·ª©ng (ESC): ${data.phan_loai_trieu_chung.toUpperCase()}`;

  // Nguy c∆°
  const risk=data.muc_nguy_co;
  const riskBox=document.getElementById("riskBox");

  if (risk==="cao"){
    riskBox.style.background="#f8d7da";
    riskBox.style.borderLeft="5px solid #d9534f";
  } else if (risk==="trung_binh"){
    riskBox.style.background="#fff3cd";
    riskBox.style.borderLeft="5px solid #f0ad4e";
  } else {
    riskBox.style.background="#d4edda";
    riskBox.style.borderLeft="5px solid #5cb85c";
  }

  riskBox.textContent =
    `M·ª©c nguy c∆°: ${data.muc_nguy_co.toUpperCase()}\n` +
    `Ch·∫©n ƒëo√°n g·ª£i √Ω: ${data.chan_doan_goi_y}`;

  // Khuy·∫øn c√°o
  adviceBox.textContent =
    `Khuy·∫øn c√°o:\n- ${data.khuyen_cao[0]}\n- ${data.khuyen_cao[1]}`;

  // ECG k·∫øt lu·∫≠n
  document.getElementById("ecgAI").innerHTML =
    `<b>üìà AI ƒë·ªçc ECG:</b><br>${data.ecg.ket_luan_ecg}`;
});
</script>

</body>
</html>
